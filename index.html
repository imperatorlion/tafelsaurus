<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Retro Jungle Math Quest â€“ Tafels</title>
  <style>
    :root{--gb-dark:#0f380f;--gb-mid:#306230;--gb-light:#8bac0f;--gb-bg:#c4cfa1;--shell:#555;--paper:#d7dfb5;}
    body{background:#1b1b1b;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;user-select:none;}
    #gameboy{background:var(--gb-bg);border:10px solid var(--shell);border-radius:22px;padding:18px;width:440px;box-shadow:0 18px 40px rgba(0,0,0,.45);}
    #screenWrap{position:relative;width:400px;height:270px;margin:0 auto;border:6px solid #3a3a3a;border-radius:12px;background:var(--gb-light);box-sizing:border-box;overflow:hidden;}

    /* Jungle */
    #world{position:absolute;left:0;top:0;height:100%;width:10000px;
      background:
        radial-gradient(circle at 30px 30px, rgba(15,56,15,.18) 0 10px, transparent 11px 100%),
        radial-gradient(circle at 120px 80px, rgba(15,56,15,.14) 0 12px, transparent 13px 100%),
        radial-gradient(circle at 220px 40px, rgba(15,56,15,.16) 0 9px, transparent 10px 100%),
        linear-gradient(0deg, rgba(15,56,15,.16), rgba(15,56,15,.06));
      background-size: 280px 140px, 320px 180px, 260px 150px, auto;}
    #canopy{position:absolute;left:0;top:0;height:45%;width:100%;background:repeating-linear-gradient(90deg, rgba(15,56,15,.18) 0 12px, rgba(15,56,15,.10) 12px 26px),linear-gradient(180deg, rgba(15,56,15,.18), transparent);opacity:.9;pointer-events:none;}
    #vines{position:absolute;inset:0;pointer-events:none;opacity:.55;background:repeating-linear-gradient(110deg, transparent 0 90px, rgba(15,56,15,.14) 90px 92px, transparent 92px 160px);}
    #ground{position:absolute;left:0;bottom:0;height:34%;width:100%;background:repeating-linear-gradient(90deg, rgba(15,56,15,.22) 0 10px, rgba(15,56,15,.12) 10px 22px),linear-gradient(0deg, rgba(15,56,15,.16), rgba(15,56,15,.10));border-top:3px solid rgba(15,56,15,.28);}

    #runner{position:absolute;left:40px;bottom:76px;font-size:28px;text-shadow:1px 1px 0 rgba(196,207,161,.8);transform:scaleX(1);}
    #runner.face-left{transform:scaleX(-1);}    

    .chest{position:absolute;bottom:76px;font-size:22px;filter:contrast(1.1);} 
    .chest.open{opacity:.35;filter:grayscale(1);} 

    /* HUD */
    #hud{display:flex;justify-content:space-between;align-items:center;margin:10px auto 0;width:400px;color:#222;font-size:12px;gap:10px;}
    #hud>div{white-space:nowrap;}
    #hint{margin:10px auto 0;width:400px;font-size:12px;color:#2b2b2b;opacity:.9;line-height:1.2;}

    /* Question modal */
    #question{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(196,207,161,.65);} 
    #qCard{width:340px;border:4px solid var(--gb-dark);border-radius:14px;background:var(--paper);padding:10px;box-shadow:0 10px 24px rgba(0,0,0,.25);color:var(--gb-dark);} 
    #qTitle{font-weight:900;letter-spacing:1px;} 
    #qText{margin-top:8px;white-space:pre-wrap;line-height:1.2;font-weight:900;} 
    #answerRow{display:flex;gap:10px;margin-top:10px;align-items:center;} 
    #answerInput{flex:1;padding:10px 10px;border:3px solid var(--gb-dark);border-radius:12px;background:var(--gb-bg);color:var(--gb-dark);font-family:inherit;font-weight:900;font-size:16px;outline:none;} 
    #submitBtn{padding:10px 10px;border:3px solid var(--gb-dark);border-radius:12px;background:var(--gb-bg);color:var(--gb-dark);font-family:inherit;font-weight:900;cursor:pointer;box-shadow:0 4px 0 rgba(15,56,15,.4);} 
    #submitBtn:active{transform:translateY(2px);box-shadow:0 2px 0 rgba(15,56,15,.4);} 
    #qFooter{margin-top:8px;font-size:11px;opacity:.85;} 

    /* Toast */
    #toast{position:absolute;left:10px;right:10px;bottom:10px;padding:8px 10px;border:3px solid rgba(15,56,15,.35);border-radius:12px;background:rgba(215,223,181,.85);color:var(--gb-dark);font-weight:800;display:none;box-shadow:0 10px 20px rgba(0,0,0,.22);} 

    /* Soccer bonus */
    #soccer{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(196,207,161,.55);} 
    #pitch{width:360px;height:235px;border:4px solid var(--gb-dark);border-radius:14px;position:relative;background:linear-gradient(0deg, rgba(15,56,15,.14), rgba(15,56,15,.07)),repeating-linear-gradient(90deg, rgba(15,56,15,.06) 0 18px, rgba(15,56,15,.02) 18px 36px);overflow:hidden;} 
    #pitchTitle{position:absolute;left:0;right:0;top:10px;text-align:center;font-weight:900;letter-spacing:2px;color:var(--gb-dark);text-shadow:1px 1px 0 rgba(196,207,161,.9);} 
    #goal{position:absolute;top:48px;width:70px;height:26px;border:4px solid var(--gb-dark);border-bottom:none;border-radius:10px 10px 0 0;background:rgba(196,207,161,.35);} 
    #net{position:absolute;inset:0;background:repeating-linear-gradient(90deg, rgba(15,56,15,.12) 0 4px, transparent 4px 10px),repeating-linear-gradient(0deg, rgba(15,56,15,.12) 0 4px, transparent 4px 10px);opacity:.35;border-radius:10px 10px 0 0;} 
    #ball{position:absolute;font-size:18px;} 
    #shotLine{position:absolute;left:0;right:0;bottom:12px;height:0;border-top:3px dashed rgba(15,56,15,.25);} 
    #soccerHelp{position:absolute;left:10px;right:10px;bottom:10px;font-size:11px;opacity:.9;color:var(--gb-dark);font-weight:800;} 
  </style>
</head>
<body>
  <div id="gameboy">
    <div id="screenWrap">
      <div id="world">
        <div id="canopy"></div>
        <div id="vines"></div>
        <div id="ground"></div>
        <div id="runner">ðŸ¦–</div>
      </div>

      <div id="question" aria-hidden="true">
        <div id="qCard">
          <div id="qTitle">LEVEL</div>
          <div id="qText">Vraag</div>
          <div id="answerRow">
            <input id="answerInput" inputmode="numeric" autocomplete="off" placeholder="antwoord" />
            <button id="submitBtn">OK</button>
          </div>
          <div id="qFooter">Alleen cijfers â€¢ ENTER = OK</div>
        </div>
      </div>

      <div id="soccer" aria-hidden="true">
        <div id="pitch">
          <div id="pitchTitle">LEVEL BONUS!</div>
          <div id="goal"><div id="net"></div></div>
          <div id="ball">âš½</div>
          <div id="shotLine"></div>
          <div id="soccerHelp">â—€ â–¶ verplaats bal â€¢ ENTER schiet</div>
        </div>
      </div>

      <div id="toast"></div>
    </div>

    <div id="hud">
      <div id="levelLabel">LEVEL 1/6</div>
      <div id="tableLabel">TAFEL 5</div>
      <div id="progressLabel">VRAAG 0/5</div>
      <div id="scoreLabel">SCORE: 0</div>
    </div>

    <div id="hint">Controls: â—€ â–¶ lopen â€¢ Loop tegen een kist ðŸ§° â€¢ Antwoord typen (cijfers) â€¢ ENTER</div>
  </div>

  <script>
    // ===== Levels: tafels (6 levels) =====
    const LEVELS = [{table:5},{table:4},{table:2},{table:10},{table:7},{table:8}];

    // ===== DOM =====
    const world = document.getElementById('world');
    const runner = document.getElementById('runner');

    const question = document.getElementById('question');
    const qTitle = document.getElementById('qTitle');
    const qText = document.getElementById('qText');
    const answerInput = document.getElementById('answerInput');
    const submitBtn = document.getElementById('submitBtn');

    const soccer = document.getElementById('soccer');
    const goal = document.getElementById('goal');
    const ballEl = document.getElementById('ball');

    const toast = document.getElementById('toast');

    const levelLabel = document.getElementById('levelLabel');
    const tableLabel = document.getElementById('tableLabel');
    const progressLabel = document.getElementById('progressLabel');
    const scoreLabel = document.getElementById('scoreLabel');

    // ===== World constants =====
    const VIEW_W = 400;
    const WORLD_W = 10000;
    const SPEED = 2.25;

    // ===== State =====
    let keys = { left:false, right:false };

    let paused = false;          // freezes runner movement
    let runnerX = 40;
    let camX = 0;

    let level = 0;
    let score = 0;

    const totalQuestions = 5;    // ALWAYS 5 per level
    let askedCount = 0;          // 0..5
    let correctCount = 0;        // for points feedback only

    let chests = [];             // {x, el, used:false}
    let currentQ = null;         // {a,b,ans}
    let activeChestIndex = -1;   // prevents double-trigger

    // Soccer
    let soccerActive = false;
    let ballX = 170, ballY = 180;
    let goalX = 30, goalV = 1.6;
    let shooting = false;

    // ===== Helpers =====
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

    function toastMsg(m){
      toast.style.display = 'block';
      toast.textContent = m;
      clearTimeout(toastMsg._t);
      toastMsg._t = setTimeout(()=> toast.style.display='none', 1200);
    }

    function buildProps(){
      // Optional: add a few decorative plants (lightweight)
      world.querySelectorAll('.prop').forEach(n => n.remove());
      for (let i=0;i<60;i++){
        const p = document.createElement('div');
        p.className = 'prop';
        p.textContent = (i%6===0) ? 'ðŸŒ¿' : (i%6===1) ? 'ðŸŒ´' : (i%6===2) ? 'ðŸª´' : (i%6===3) ? 'ðŸƒ' : (i%6===4) ? 'ðŸŒ±' : 'ðŸŒ³';
        p.style.left = (randInt(0, 9800)) + 'px';
        p.style.bottom = (randInt(78, 155)) + 'px';
        p.style.opacity = (0.35 + Math.random()*0.45).toFixed(2);
        p.style.fontSize = randInt(16, 22) + 'px';
        world.appendChild(p);
      }
    }

    function clearChests(){
      world.querySelectorAll('.chest').forEach(n => n.remove());
      chests = [];
    }

    function addChest(x){
      const el = document.createElement('div');
      el.className = 'chest';
      el.textContent = 'ðŸ§°';
      el.style.left = x + 'px';
      world.appendChild(el);
      chests.push({ x, el, used:false });
    }

    function updateHUD(){
      levelLabel.textContent = `LEVEL ${level+1}/6`;
      tableLabel.textContent = `TAFEL ${LEVELS[level].table}`;
      progressLabel.textContent = `VRAAG ${askedCount}/${totalQuestions}`;
      scoreLabel.textContent = `SCORE: ${score}`;
    }

    function faceTowardNextChest(){
      let best = null;
      for (const c of chests){
        if (c.used) continue;
        const d = Math.abs(c.x - runnerX);
        if (!best || d < best.d) best = { d, x: c.x };
      }
      if (!best) return;
      if (best.x < runnerX) runner.classList.add('face-left');
      else runner.classList.remove('face-left');
    }

    function makeQuestionForTable(t){
      // Only 1..10
      const a = randInt(1, 10);
      const b = t;
      return { a, b, ans: a*b };
    }

    // ===== Level flow =====
    function initLevel(i){
      level = i;
      askedCount = 0;
      correctCount = 0;
      runnerX = 40;
      camX = 0;
      paused = false;
      activeChestIndex = -1;
      currentQ = null;
      keys.left = false;
      keys.right = false;

      buildProps();
      clearChests();

      // Place EXACTLY 5 chests (one per question)
      for (let k=0;k<5;k++) addChest(520 + k*488 + randInt(-40, 60));

      updateHUD();
      toastMsg(`START: tafel van ${LEVELS[level].table}`);
    }

    function openQuestionForChest(idx){
      const chest = chests[idx];
      if (!chest || chest.used) return;

      // Mark used immediately so it can't retrigger
      chest.used = true;
      chest.el.classList.add('open');
      chest.el.textContent = 'ðŸ“¦';

      activeChestIndex = idx;
      paused = true;

      const t = LEVELS[level].table;
      currentQ = makeQuestionForTable(t);

      qTitle.textContent = `LEVEL ${level+1} â€” TAFEL ${t}`;
      qText.textContent = `${currentQ.a} Ã— ${currentQ.b} = ?`;

      answerInput.value = '';
      question.style.display = 'flex';
      question.setAttribute('aria-hidden','false');
      setTimeout(()=> answerInput.focus(), 0);
    }

    function closeQuestion(){
      question.style.display = 'none';
      question.setAttribute('aria-hidden','true');
      try { answerInput.blur(); } catch(e) {}
      currentQ = null;
      activeChestIndex = -1;
    }

    function finishQuestion(){
      if (!currentQ) return;
      const raw = answerInput.value.trim();
      if (raw === '') return toastMsg('Typ een getal.');

      const correctAns = currentQ.ans;
      const given = Number(raw);
      const ok = Number.isFinite(given) && given === correctAns;

      closeQuestion();

      askedCount++;
      if (ok) {
        correctCount++;
        score += 5;
        toastMsg('âœ… JUIST!');
      } else {
        toastMsg(`âŒ FOUT (juist was ${correctAns})`);
      }

      updateHUD();
      paused = false;
      keys.left = false;
      keys.right = false;

      if (askedCount >= totalQuestions) {
        setTimeout(()=> startSoccerBonus(), 450);
      }
    }

    // Digit-only input
    answerInput.addEventListener('beforeinput', (e) => {
      if (e.data && /[^0-9]/.test(e.data)) e.preventDefault();
    });
    answerInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') finishQuestion();
      if (e.key.length === 1 && /[^0-9]/.test(e.key)) e.preventDefault();
    });
    submitBtn.addEventListener('click', finishQuestion);

    // ===== Soccer bonus =====
    function startSoccerBonus(){
      paused = true;
      soccerActive = true;
      shooting = false;

      ballX = 170;
      ballY = 180;
      goalX = 30;
      goalV = 1.6;

      ballEl.style.left = ballX + 'px';
      ballEl.style.top = ballY + 'px';
      goal.style.left = goalX + 'px';

      soccer.style.display = 'flex';
      soccer.setAttribute('aria-hidden','false');
      toastMsg('LEVEL BONUS: scoor met âš½ voor +10!');
    }

    function endSoccerBonus(scored){
      soccer.style.display = 'none';
      soccer.setAttribute('aria-hidden','true');
      soccerActive = false;
      shooting = false;

      if (scored) { score += 10; toastMsg('âš½ GOAL! +10'); }
      else { toastMsg('âš½ MISS â€” geen bonus'); }
      updateHUD();

      setTimeout(()=>{
        if (level < LEVELS.length - 1) {
          initLevel(level + 1);
        } else {
          // End screen (reuse question modal)
          paused = true;
          question.style.display = 'flex';
          question.setAttribute('aria-hidden','false');
          qTitle.textContent = 'KLAAR!';
          qText.textContent = `Eindscore: ${score}

Druk ENTER om opnieuw te starten.`;
          answerInput.value = '';
          answerInput.placeholder = 'ENTER';
          setTimeout(()=> answerInput.focus(), 0);
          // special marker
          activeChestIndex = -999;
        }
      }, 650);
    }

    function updateSoccer(){
      if (!soccerActive) return;

      // Move goal left/right
      goalX += goalV;
      if (goalX < 10){ goalX = 10; goalV = Math.abs(goalV); }
      if (goalX > 360 - 70 - 10){ goalX = 360 - 70 - 10; goalV = -Math.abs(goalV); }
      goal.style.left = goalX + 'px';

      if (shooting) {
        ballY -= 3.2;
        if (ballY <= 64) {
          const ballCenter = ballX + 9;
          const goalLeft = goalX;
          const goalRight = goalX + 70;
          const scored = (ballCenter >= goalLeft + 8 && ballCenter <= goalRight - 8);
          endSoccerBonus(scored);
          return;
        }
        if (ballY < 10) {
          endSoccerBonus(false);
          return;
        }
      }

      ballEl.style.left = ballX + 'px';
      ballEl.style.top = ballY + 'px';
    }

    function soccerMoveLeft(){ if (shooting) return; ballX = Math.max(10, ballX - 6); }
    function soccerMoveRight(){ if (shooting) return; ballX = Math.min(360 - 20, ballX + 6); }
    function soccerShoot(){ if (shooting) return; shooting = true; }

    // ===== Input (movement always works unless modal is open) =====
    window.addEventListener('keydown', (e) => {
      // Soccer controls
      if (soccerActive) {
        if (e.key === 'ArrowLeft') soccerMoveLeft();
        if (e.key === 'ArrowRight') soccerMoveRight();
        if (e.key === 'Enter') soccerShoot();
        e.preventDefault();
        return;
      }

      // End screen restart
      if (question.style.display === 'flex' && activeChestIndex === -999) {
        if (e.key === 'Enter') {
          answerInput.placeholder = 'antwoord';
          score = 0;
          initLevel(0);
          question.style.display = 'none';
          paused = false;
        }
        return;
      }

      // If question modal open, don't move runner
      if (question.style.display === 'flex') return;

      if (e.key === 'ArrowLeft') { keys.left = true; e.preventDefault(); }
      if (e.key === 'ArrowRight') { keys.right = true; e.preventDefault(); }
    });

    window.addEventListener('keyup', (e) => {
      if (soccerActive) return;
      if (question.style.display === 'flex') return;
      if (e.key === 'ArrowLeft') { keys.left = false; e.preventDefault(); }
      if (e.key === 'ArrowRight') { keys.right = false; e.preventDefault(); }
    });

    // ===== Game loop =====
    function tick(){
      if (!paused && !soccerActive && question.style.display !== 'flex') {
        const dx = (keys.right ? SPEED : 0) - (keys.left ? SPEED : 0);
        runnerX += dx;
        runnerX = Math.max(10, Math.min(WORLD_W - 60, runnerX));

        faceTowardNextChest();

        camX = Math.max(0, runnerX - 130);
        camX = Math.min(WORLD_W - VIEW_W, camX);

        world.style.transform = `translateX(${-camX}px)`;
        runner.style.left = runnerX + 'px';

        // Collision with unused chests (each chest triggers at most once)
        for (let i=0;i<chests.length;i++){
          const c = chests[i];
          if (c.used) continue;
          if (Math.abs(runnerX - c.x) < 18) {
            openQuestionForChest(i);
            break;
          }
        }
      }

      updateSoccer();
      requestAnimationFrame(tick);
    }

    // START
    initLevel(0);
    requestAnimationFrame(tick);
  </script>
</body>
</html>
